<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Presale DApp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .wallet-info {
            background: linear-gradient(135deg, #00b4db 0%, #0083b0 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .wallet-status {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .wallet-address {
            font-family: monospace;
            font-size: 0.9rem;
            opacity: 0.9;
            word-break: break-all;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        button {
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status-log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .loading {
            opacity: 0.7;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .warning {
            color: #ffc107;
        }

        .info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Solana Presale DApp</h1>
        
        <div class="wallet-info" id="walletInfo">
            <div class="wallet-status" id="walletStatus">Wallet not connected</div>
            <div class="wallet-address" id="walletAddress"></div>
        </div>

        <div class="button-grid">
            <button id="connectWallet">Connect Wallet</button>
            <button id="disconnectWallet" disabled style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">Disconnect Wallet</button>
            <button id="initPresale" disabled>Initialize Presale</button>
            <button id="buyTokens" disabled>Buy Tokens</button>
            <button id="claimTokens" disabled>Claim Tokens</button>
            <button id="endPresale" disabled>End Presale</button>
            <button id="withdrawTokens" disabled>Withdraw Tokens</button>
            <button id="withdrawUsd" disabled>Withdraw USD</button>
            <button id="claimRefund" disabled>Claim Refund</button>
        </div>

        <div class="input-group">
            <label for="paymentAmount">Payment Amount (USDC):</label>
            <input type="number" id="paymentAmount" placeholder="Enter amount in USDC" step="0.000001" value="10">
        </div>

        <div class="input-group">
            <label for="tokenMintAddress">Token Mint Address:</label>
            <input type="text" id="tokenMintAddress" placeholder="Enter token mint address">
        </div>

        <div class="input-group">
            <label for="usdMintAddress">USD Mint Address (Devnet USDC):</label>
            <input type="text" id="usdMintAddress" placeholder="Enter USDC mint address" value="4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU">
        </div>

        <div class="input-group">
            <label for="presaleSeed">Presale Seed:</label>
            <input type="number" id="presaleSeed" placeholder="Enter presale seed" value="12345">
        </div>

        <div class="status-log" id="statusLog">Ready to connect wallet...\n</div>
    </div>

    <!-- Load Solana Web3.js and Anchor -->
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.78.8/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@project-serum/anchor@0.30.1/dist/browser/bundle.js"></script>
    
    <script>
        // Global variables
        let wallet = null;
        let connection = null;
        let program = null;
        let provider = null;
        const PROGRAM_ID = 'B2sYczbsC9WPbxJHLK1cQDQ48NnFjCpv42styrjv9PdS';
        const NETWORK = 'devnet'; // Change to 'mainnet-beta' for mainnet

        // Your complete IDL
        const IDL = {
            "address": "B2sYczbsC9WPbxJHLK1cQDQ48NnFjCpv42styrjv9PdS",
            "metadata": {
                "name": "presalee",
                "version": "0.1.0",
                "spec": "0.1.0",
                "description": "Created with Anchor"
            },
            "instructions": [
                {
                    "name": "buy_tokens",
                    "discriminator": [189, 21, 230, 133, 247, 2, 110, 42],
                    "accounts": [
                        { "name": "buyer", "writable": true, "signer": true },
                        { "name": "token_mint_address", "relations": ["presale"] },
                        { "name": "usd_mint", "relations": ["presale"] },
                        {
                            "name": "presale",
                            "writable": true,
                            "pda": {
                                "seeds": [
                                    { "kind": "const", "value": [100, 111, 103, 120, 95, 112, 114, 101, 115, 97, 108, 101] },
                                    { "kind": "account", "path": "presale.admin", "account": "Presale" },
                                    { "kind": "account", "path": "presale.seed", "account": "Presale" }
                                ]
                            }
                        },
                        {
                            "name": "buyer_ata",
                            "writable": true,
                            "pda": {
                                "seeds": [
                                    { "kind": "account", "path": "buyer" },
                                    { "kind": "const", "value": [6, 221, 246, 225, 215, 101, 161, 147, 217, 203, 225, 70, 206, 235, 121, 172, 28, 180, 133, 237, 95, 91, 55, 145, 58, 140, 245, 133, 126, 255, 0, 169] },
                                    { "kind": "account", "path": "usd_mint" }
                                ],
                                "program": {
                                    "kind": "const",
                                    "value": [140, 151, 37, 143, 78, 36, 137, 241, 187, 61, 16, 41, 20, 142, 13, 131, 11, 90, 19, 153, 218, 255, 16, 132, 4, 142, 123, 216, 219, 233, 248, 89]
                                }
                            }
                        },
                        {
                            "name": "vault_usd",
                            "writable": true,
                            "pda": {
                                "seeds": [
                                    { "kind": "account", "path": "presale" },
                                    { "kind": "const", "value": [6, 221, 246, 225, 215, 101, 161, 147, 217, 203, 225, 70, 206, 235, 121, 172, 28, 180, 133, 237, 95, 91, 55, 145, 58, 140, 245, 133, 126, 255, 0, 169] },
                                    { "kind": "account", "path": "usd_mint" }
                                ],
                                "program": {
                                    "kind": "const",
                                    "value": [140, 151, 37, 143, 78, 36, 137, 241, 187, 61, 16, 41, 20, 142, 13, 131, 11, 90, 19, 153, 218, 255, 16, 132, 4, 142, 123, 216, 219, 233, 248, 89]
                                }
                            }
                        },
                        {
                            "name": "user",
                            "writable": true,
                            "pda": {
                                "seeds": [
                                    { "kind": "const", "value": [117, 115, 101, 114] },
                                    { "kind": "account", "path": "presale" },
                                    { "kind": "account", "path": "buyer" }
                                ]
                            }
                        },
                        { "name": "system_program", "address": "11111111111111111111111111111111" },
                        { "name": "associated_token_program", "address": "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL" },
                        { "name": "token_program", "address": "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA" }
                    ],
                    "args": [{ "name": "payment", "type": "u64" }]
                },
                {
                    "name": "init_presale",
                    "discriminator": [172, 248, 47, 226, 223, 52, 94, 217],
                    "accounts": [
                        { "name": "admin", "writable": true, "signer": true },
                        { "name": "token_mint_address" },
                        { "name": "usd_mint" },
                        {
                            "name": "presale",
                            "writable": true,
                            "pda": {
                                "seeds": [
                                    { "kind": "const", "value": [100, 111, 103, 120, 95, 112, 114, 101, 115, 97, 108, 101] },
                                    { "kind": "account", "path": "admin" },
                                    { "kind": "arg", "path": "seed" }
                                ]
                            }
                        },
                        {
                            "name": "vault_dog",
                            "writable": true,
                            "pda": {
                                "seeds": [
                                    { "kind": "account", "path": "presale" },
                                    { "kind": "const", "value": [6, 221, 246, 225, 215, 101, 161, 147, 217, 203, 225, 70, 206, 235, 121, 172, 28, 180, 133, 237, 95, 91, 55, 145, 58, 140, 245, 133, 126, 255, 0, 169] },
                                    { "kind": "account", "path": "token_mint_address" }
                                ],
                                "program": {
                                    "kind": "const",
                                    "value": [140, 151, 37, 143, 78, 36, 137, 241, 187, 61, 16, 41, 20, 142, 13, 131, 11, 90, 19, 153, 218, 255, 16, 132, 4, 142, 123, 216, 219, 233, 248, 89]
                                }
                            }
                        },
                        {
                            "name": "vault_usd",
                            "writable": true,
                            "pda": {
                                "seeds": [
                                    { "kind": "account", "path": "presale" },
                                    { "kind": "const", "value": [6, 221, 246, 225, 215, 101, 161, 147, 217, 203, 225, 70, 206, 235, 121, 172, 28, 180, 133, 237, 95, 91, 55, 145, 58, 140, 245, 133, 126, 255, 0, 169] },
                                    { "kind": "account", "path": "usd_mint" }
                                ],
                                "program": {
                                    "kind": "const",
                                    "value": [140, 151, 37, 143, 78, 36, 137, 241, 187, 61, 16, 41, 20, 142, 13, 131, 11, 90, 19, 153, 218, 255, 16, 132, 4, 142, 123, 216, 219, 233, 248, 89]
                                }
                            }
                        },
                        { "name": "system_program", "address": "11111111111111111111111111111111" },
                        { "name": "token_program", "address": "TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA" },
                        { "name": "associated_token_program", "address": "ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL" }
                    ],
                    "args": [
                        { "name": "seed", "type": "u64" },
                        { "name": "token_mint_address", "type": "pubkey" },
                        { "name": "usd_mint", "type": "pubkey" },
                        { "name": "softcap_amount", "type": "u64" },
                        { "name": "hardcap_amount", "type": "u64" },
                        { "name": "deposit_token_amount", "type": "u64" },
                        { "name": "levels", "type": { "array": [{ "defined": { "name": "Level" } }, 7] } },
                        { "name": "sold_token_amount", "type": "u64" },
                        { "name": "start_time", "type": "u64" },
                        { "name": "end_time", "type": "u64" }
                    ]
                }
            ],
            "accounts": [
                { "name": "Presale", "discriminator": [38, 215, 222, 14, 115, 220, 52, 168] },
                { "name": "UserInfo", "discriminator": [83, 134, 200, 56, 144, 56, 10, 62] }
            ],
            "types": [
                {
                    "name": "Level",
                    "type": {
                        "kind": "struct",
                        "fields": [
                            { "name": "token_amount", "type": "u64" },
                            { "name": "price", "type": "u64" },
                            { "name": "soft_cap", "type": "u64" },
                            { "name": "tokens_sold", "type": "u64" }
                        ]
                    }
                },
                {
                    "name": "Presale",
                    "type": {
                        "kind": "struct",
                        "fields": [
                            { "name": "seed", "type": "u64" },
                            { "name": "admin", "type": "pubkey" },
                            { "name": "is_live", "type": "bool" },
                            { "name": "current_level", "type": "u8" },
                            { "name": "levels", "type": { "array": [{ "defined": { "name": "Level" } }, 7] } },
                            { "name": "sold_token_amount", "type": "u64" },
                            { "name": "token_mint_address", "type": "pubkey" },
                            { "name": "usd_mint", "type": "pubkey" },
                            { "name": "softcap_amount", "type": "u64" },
                            { "name": "hardcap_amount", "type": "u64" },
                            { "name": "deposit_token_amount", "type": "u64" },
                            { "name": "start_time", "type": "u64" },
                            { "name": "end_time", "type": "u64" },
                            { "name": "is_soft_capped", "type": "bool" },
                            { "name": "is_hard_capped", "type": "bool" },
                            { "name": "bump", "type": "u8" }
                        ]
                    }
                },
                {
                    "name": "UserInfo",
                    "type": {
                        "kind": "struct",
                        "fields": [
                            { "name": "buyer", "type": "pubkey" },
                            { "name": "buy_quote_amount", "type": "u64" },
                            { "name": "buy_token_amount", "type": "u64" },
                            { "name": "has_claimed_token", "type": "bool" },
                            { "name": "has_claimed_refund", "type": "bool" },
                            { "name": "buy_time", "type": "u64" },
                            { "name": "claim_amount", "type": "u64" },
                            { "name": "claim_time", "type": "u64" },
                            { "name": "bump", "type": "u8" }
                        ]
                    }
                }
            ]
        };

        // Utility functions
        function log(message, type = 'info') {
            const statusLog = document.getElementById('statusLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            statusLog.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            statusLog.scrollTop = statusLog.scrollHeight;
        }

        function setButtonsEnabled(enabled) {
            const buttons = document.querySelectorAll('button:not(#connectWallet):not(#disconnectWallet)');
            buttons.forEach(button => {
                button.disabled = !enabled;
            });
            
            // Handle disconnect button state
            const disconnectButton = document.getElementById('disconnectWallet');
            disconnectButton.disabled = !enabled;
        }

        function updateWalletInfo(publicKey) {
            const walletStatus = document.getElementById('walletStatus');
            const walletAddress = document.getElementById('walletAddress');
            
            if (publicKey) {
                walletStatus.textContent = '✅ Wallet Connected';
                walletAddress.textContent = publicKey.toString();
                setButtonsEnabled(true);
            } else {
                walletStatus.textContent = '❌ Wallet not connected';
                walletAddress.textContent = '';
                setButtonsEnabled(false);
            }
        }

        // Helper function to derive PDA
        function findProgramAddress(seeds, programId) {
            try {
                const [pda, bump] = solanaWeb3.PublicKey.findProgramAddressSync(
                    seeds,
                    new solanaWeb3.PublicKey(programId)
                );
                return { pda, bump };
            } catch (error) {
                log(`Error deriving PDA: ${error.message}`, 'error');
                return null;
            }
        }

        // Helper function to get Associated Token Address
        async function getAssociatedTokenAddress(mint, owner, allowOwnerOffCurve = false) {
            const ASSOCIATED_TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL');
            const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA');
            
            const [address] = await solanaWeb3.PublicKey.findProgramAddress(
                [
                    owner.toBuffer(),
                    TOKEN_PROGRAM_ID.toBuffer(),
                    mint.toBuffer(),
                ],
                ASSOCIATED_TOKEN_PROGRAM_ID
            );
            return address;
        }

        // Wallet disconnect
        async function disconnectWallet() {
            const button = document.getElementById('disconnectWallet');
            button.disabled = true;
            button.textContent = 'Disconnecting...';
            
            try {
                log('Disconnecting wallet...');

                if (wallet && typeof wallet.disconnect === 'function') {
                    await wallet.disconnect();
                    log('Wallet disconnected via wallet.disconnect()', 'success');
                } else if (window.phantom?.solana?.disconnect) {
                    await window.phantom.solana.disconnect();
                    log('Wallet disconnected via phantom.solana.disconnect()', 'success');
                } else {
                    log('Wallet disconnect method not available, clearing local references', 'warning');
                }

                // Clear local references
                wallet = null;
                connection = null;
                program = null;
                provider = null;
                
                log('Wallet disconnected successfully!', 'success');
                updateWalletInfo(null);

            } catch (error) {
                log(`Error disconnecting wallet: ${error.message}`, 'error');
                
                // Even if disconnect fails, clear local references
                wallet = null;
                connection = null;
                updateWalletInfo(null);
                
            } finally {
                button.disabled = false;
                button.textContent = 'Disconnect Wallet';
            }
        }
        async function connectWallet() {
            const button = document.getElementById('connectWallet');
            button.disabled = true;
            button.textContent = 'Connecting...';
            
            try {
                log('Checking for Phantom wallet...');

                // Wait for phantom to be available
                if (typeof window.phantom === 'undefined') {
                    log('Waiting for Phantom wallet to load...', 'warning');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                if (!window.phantom?.solana) {
                    throw new Error('Phantom wallet not found. Please install Phantom wallet from https://phantom.app');
                }

                log('Phantom wallet detected, attempting connection...');
                const response = await window.phantom.solana.connect();
                wallet = window.phantom.solana;
                
                // Initialize connection
                const rpcUrl = NETWORK === 'mainnet-beta' 
                    ? 'https://api.mainnet-beta.solana.com'
                    : 'https://api.devnet.solana.com';
                    
                connection = new solanaWeb3.Connection(rpcUrl, 'confirmed');

                log(`Wallet connected successfully!`, 'success');
                log(`Public Key: ${response.publicKey.toString()}`, 'info');
                log(`Network: ${NETWORK}`, 'info');
                
                // Initialize Anchor provider and program
                try {
                    provider = new anchor.AnchorProvider(
                        connection,
                        wallet,
                        { commitment: 'confirmed' }
                    );
                    anchor.setProvider(provider);
                    
                    const programId = new solanaWeb3.PublicKey(PROGRAM_ID);
                    program = new anchor.Program(IDL, programId, provider);
                    
                    log('Anchor program initialized successfully!', 'success');
                } catch (anchorError) {
                    log(`Warning: Could not initialize Anchor program: ${anchorError.message}`, 'warning');
                    log('Falling back to manual transaction building', 'info');
                }
                
                updateWalletInfo(response.publicKey);

                // Check wallet balance
                const balance = await connection.getBalance(response.publicKey);
                log(`SOL Balance: ${balance / solanaWeb3.LAMPORTS_PER_SOL} SOL`, 'info');

            } catch (error) {
                log(`Failed to connect wallet: ${error.message}`, 'error');
                updateWalletInfo(null);
            } finally {
                button.disabled = false;
                button.textContent = 'Connect Wallet';
            }
        }

        // Initialize presale with IDL support
        async function initializePresale() {
            const button = document.getElementById('initPresale');
            button.disabled = true;
            button.textContent = 'Initializing...';

            try {
                if (!wallet || !connection) {
                    throw new Error('Please connect your wallet first');
                }

                log('Initializing presale...');
                
                const tokenMintInput = document.getElementById('tokenMintAddress').value.trim();
                const usdMintInput = document.getElementById('usdMintAddress').value.trim();
                const seedInput = document.getElementById('presaleSeed').value;

                if (!tokenMintInput || !usdMintInput || !seedInput) {
                    throw new Error('Please provide token mint, USD mint addresses, and seed');
                }

                const tokenMint = new solanaWeb3.PublicKey(tokenMintInput);
                const usdMint = new solanaWeb3.PublicKey(usdMintInput);
                const seed = parseInt(seedInput);

                // Try to use Anchor if available
                if (program) {
                    log('Using Anchor program for initialization...', 'info');
                    
                    // Example levels structure - adjust according to your needs
                    const levels = [
                        { tokenAmount: new anchor.BN(1000000), price: new anchor.BN(100000), softCap: new anchor.BN(0), tokensSold: new anchor.BN(0) },
                        { tokenAmount: new anchor.BN(2000000), price: new anchor.BN(110000), softCap: new anchor.BN(0), tokensSold: new anchor.BN(0) },
                        { tokenAmount: new anchor.BN(3000000), price: new anchor.BN(120000), softCap: new anchor.BN(0), tokensSold: new anchor.BN(0) },
                        { tokenAmount: new anchor.BN(4000000), price: new anchor.BN(130000), softCap: new anchor.BN(0), tokensSold: new anchor.BN(0) },
                        { tokenAmount: new anchor.BN(5000000), price: new anchor.BN(140000), softCap: new anchor.BN(0), tokensSold: new anchor.BN(0) },
                        { tokenAmount: new anchor.BN(6000000), price: new anchor.BN(150000), softCap: new anchor.BN(0), tokensSold: new anchor.BN(0) },
                        { tokenAmount: new anchor.BN(7000000), price: new anchor.BN(160000), softCap: new anchor.BN(0), tokensSold: new anchor.BN(0) }
                    ];

                    const tx = await program.methods
                        .initPresale(
                            new anchor.BN(seed),
                            tokenMint,
                            usdMint,
                            new anchor.BN(1000000), // softcap_amount
                            new anchor.BN(10000000), // hardcap_amount
                            new anchor.BN(14000000), // deposit_token_amount
                            levels,
                            new anchor.BN(0), // sold_token_amount
                            new anchor.BN(Math.floor(Date.now() / 1000)), // start_time
                            new anchor.BN(Math.floor(Date.now() / 1000) + 7 * 24 * 3600) // end_time (7 days from now)
                        )
                        .accounts({
                            admin: wallet.publicKey,
                            tokenMintAddress: tokenMint,
                            usdMint: usdMint,
                            systemProgram: anchor.web3.SystemProgram.programId,
                            tokenProgram: anchor.utils.token.TOKEN_PROGRAM_ID,
                            associatedTokenProgram: anchor.utils.token.ASSOCIATED_PROGRAM_ID,
                        })
                        .rpc();
                    
                    log(`Presale initialized with Anchor! Tx: ${tx}`, 'success');
                    
                } else {
                    // Fallback to manual transaction building
                    log('Using manual transaction building...', 'warning');
                    
                    const programId = new solanaWeb3.PublicKey(PROGRAM_ID);
                    const seedBuffer = Buffer.alloc(8);
                    seedBuffer.writeBigUInt64LE(BigInt(seed), 0);
                    
                    const presalePda = findProgramAddress([
                        Buffer.from('dogx_presale'),
                        wallet.publicKey.toBuffer(),
                        seedBuffer
                    ], PROGRAM_ID);

                    if (!presalePda) {
                        throw new Error('Failed to derive presale PDA');
                    }

                    log(`Presale PDA: ${presalePda.pda.toString()}`, 'info');

                    // Create instruction data (you'll need to properly encode all parameters)
                    const instructionData = Buffer.concat([
                        Buffer.from([172, 248, 47, 226, 223, 52, 94, 217]), // discriminator
                        seedBuffer,
                        tokenMint.toBuffer(),
                        usdMint.toBuffer(),
                        // Add other parameters as needed - this is incomplete
                    ]);

                    const instruction = new solanaWeb3.TransactionInstruction({
                        keys: [
                            { pubkey: wallet.publicKey, isSigner: true, isWritable: true },
                            { pubkey: tokenMint, isSigner: false, isWritable: false },
                            { pubkey: usdMint, isSigner: false, isWritable: false },
                            { pubkey: presalePda.pda, isSigner: false, isWritable: true },
                            { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false },
                        ],
                        programId: programId,
                        data: instructionData
                    });

                    const transaction = new solanaWeb3.Transaction().add(instruction);
                    const { blockhash } = await connection.getLatestBlockhash();
                    transaction.recentBlockhash = blockhash;
                    transaction.feePayer = wallet.publicKey;

                    log('Sending transaction...', 'info');
                    const signedTransaction = await wallet.signTransaction(transaction);
                    const signature = await connection.sendRawTransaction(signedTransaction.serialize());
                    
                    log(`Transaction sent: ${signature}`, 'success');
                    log('Waiting for confirmation...', 'info');
                    
                    await connection.confirmTransaction(signature);
                    log(`Presale initialized successfully!`, 'success');
                }

            } catch (error) {
                log(`Failed to initialize presale: ${error.message}`, 'error');
                console.error('Full error:', error);
            } finally {
                button.disabled = false;
                button.textContent = 'Initialize Presale';
            }
        }

        // Buy tokens (simplified implementation)
        async function buyTokens() {
            const button = document.getElementById('buyTokens');
            button.disabled = true;
            button.textContent = 'Buying...';

            try {
                if (!wallet || !connection) {
                    throw new Error('Please connect your wallet first');
                }

                log('Preparing to buy tokens...');
                
                const paymentAmount = document.getElementById('paymentAmount').value;
                const usdMintInput = document.getElementById('usdMintAddress').value.trim();
                
                if (!paymentAmount || paymentAmount <= 0) {
                    throw new Error('Please enter a valid payment amount');
                }

                if (!usdMintInput) {
                    throw new Error('Please provide USD mint address');
                }

                // Convert to smallest unit (assuming 6 decimals for USDC)
                const paymentLamports = Math.floor(parseFloat(paymentAmount) * 1000000);
                
                log(`Attempting to buy tokens with ${paymentAmount} USDC (${paymentLamports} lamports)...`, 'info');
                
                // For now, just log what would happen
                log('🚧 Buy tokens function needs full implementation', 'warning');
                log('This would create a buy_tokens instruction with proper account derivations', 'warning');
                
                // You would need to:
                // 1. Derive all required PDAs (presale, user account, token accounts)
                // 2. Create proper instruction data with payment amount
                // 3. Build transaction with all required accounts
                // 4. Sign and send transaction

            } catch (error) {
                log(`Failed to buy tokens: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Buy Tokens';
            }
        }

        // Placeholder functions for other operations
        async function claimTokens() {
            log('🚧 Claim tokens function - needs implementation', 'warning');
        }

        async function endPresale() {
            log('🚧 End presale function - needs implementation', 'warning');
        }

        async function withdrawTokens() {
            log('🚧 Withdraw tokens function - needs implementation', 'warning');
        }

        async function withdrawUsd() {
            log('🚧 Withdraw USD function - needs implementation', 'warning');
        }

        async function claimRefund() {
            log('🚧 Claim refund function - needs implementation', 'warning');
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('disconnectWallet').addEventListener('click', disconnectWallet);
        document.getElementById('initPresale').addEventListener('click', initializePresale);
        document.getElementById('buyTokens').addEventListener('click', buyTokens);
        document.getElementById('claimTokens').addEventListener('click', claimTokens);
        document.getElementById('endPresale').addEventListener('click', endPresale);
        document.getElementById('withdrawTokens').addEventListener('click', withdrawTokens);
        document.getElementById('withdrawUsd').addEventListener('click', withdrawUsd);
        document.getElementById('claimRefund').addEventListener('click', claimRefund);

        // Initialize on page load
        window.addEventListener('load', async () => {
            log('DApp loaded. Checking for existing wallet connection...');
            
            // Wait a bit for Phantom to load
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Check if wallet is already connected
            if (window.phantom?.solana?.isConnected) {
                wallet = window.phantom.solana;
                const rpcUrl = NETWORK === 'mainnet-beta' 
                    ? 'https://api.mainnet-beta.solana.com'
                    : 'https://api.devnet.solana.com';
                connection = new solanaWeb3.Connection(rpcUrl, 'confirmed');
                
                updateWalletInfo(wallet.publicKey);
                log('Wallet was already connected', 'success');
            } else {
                log('Please connect your wallet to continue.', 'info');
            }
        });
    </script>
</body>
</html>